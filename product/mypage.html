<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IdeaShelf | マイページ</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    /* マイページ全体のカードを大きく（維持） */
    main.container > .card {
      padding: 22px;
      border-radius: 18px;
    }

    /* 見出しも少し大きく（維持） */
    main.container > .card h2 {
      font-size: 1.25rem;
      margin-top: 0;
    }

    /* 小さめ文字（ログイン中〜など）を読みやすく（維持） */
    main.container > .card .small {
      font-size: 0.98rem;
    }

    /* 余白感アップ（カード同士の間隔）（維持） */
    #myIdeasGrid {
      gap: 16px;
    }

    /* ✅ マイページのヘッダーボタン右寄せ（align-items:right は効かないので） */
    .nav-actions.my-actions{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end; /* 右寄せ */
    }

    /* ✅ マイページでは一覧カード(.idea)を少し大きくする（一覧ページは崩さない） */
    #myIdeasGrid .idea{
      padding: 20px;
      border-radius: 18px;
    }

    /* ✅ マイページのカード内の右側ボタン群を右寄せ */
    #myIdeasGrid .my-idea-actions{
      margin-left:auto;
      display:flex;
      gap:8px;
      align-items:center;
    }

    /* ✅ マイページの「いいね表示」は一覧っぽく小さめに */
    #myIdeasGrid .like-wrap{
      display:inline-flex;
      align-items:center;
      gap:6px;
      opacity:.9;
    }
  </style>
</head>

<body>
  <header>
    <div class="container nav">
      <a class="brand" href="index.html">
        <span class="logo" aria-hidden="true"></span>
        <span>IdeaShelf</span>
      </a>

      <!-- ✅ 右寄せを効かせるため class を追加 -->
      <div class="nav-actions my-actions">
        <a class="btn ghost" href="index.html">一覧に戻る</a>
        <a class="btn primary" href="new.html">＋ 新規投稿</a>
        <button class="btn ghost" id="logoutBtn" type="button">ログアウト</button>
      </div>
    </div>
  </header>

  <main class="container">
    <section class="hero">
      <div>
        <h1>マイページ</h1>
        <p class="small" style="opacity:.85;">アカウント情報と設定</p>
      </div>
    </section>

    <section class="card" style="margin-top:16px;">
      <h2 style="margin-top:0;">アカウント</h2>
      <div id="meBox" class="small" style="opacity:.9;">読み込み中...</div>
    </section>

    <section class="card" style="margin-top:16px;">
      <h2 style="margin-top:0;">自分のアイデア</h2>
      <div id="myIdeasGrid" class="grid"></div>
      <p id="myIdeasEmpty" class="small" style="opacity:.7; display:none; margin-top:10px;">
        まだ投稿がありません。
      </p>
    </section>

    <section class="card" style="margin-top:16px;">
      <h2 style="margin-top:0;">注意</h2>
      <p class="small" style="opacity:.85; margin-top:6px;">
        アカウントを削除すると、あなたの投稿と、あなたに紐づくデータが削除されます。
      </p>

      <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:10px;">
        <input id="confirmText" class="input" type="text" placeholder='DELETE と入力' style="width:180px;">
        <button id="deleteBtn" class="btn" type="button" disabled>アカウント削除</button>
      </div>

      <p class="small" style="opacity:.7; margin-top:10px;">
        ※誤操作防止のため、DELETE と入力するとボタンが有効になります。
      </p>
    </section>
  </main>

  <script>
    async function getMe() {
      const r = await fetch("/api/me", { credentials: "same-origin" });
      return await r.json();
    }

    async function ensureLogin() {
      const me = await getMe();
      if (!me.loggedIn) {
        alert("ログインしてください");
        location.href = "/index.html";
        return null;
      }
      document.getElementById("meBox").textContent =
        `ログイン中: ${me.username} (id:${me.userId})`;
      return me;
    }

    document.getElementById("logoutBtn").onclick = async () => {
      await fetch("/api/logout", { method: "POST", credentials: "same-origin" });
      location.href = "/index.html";
    };

    const confirmText = document.getElementById("confirmText");
    const deleteBtn = document.getElementById("deleteBtn");

    confirmText.addEventListener("input", () => {
      deleteBtn.disabled = (confirmText.value !== "DELETE");
    });

    deleteBtn.onclick = async () => {
      const ok = confirm("本当にアカウントを削除しますか？取り消しできません。");
      if (!ok) return;

      const r = await fetch("/api/account", { method: "DELETE", credentials: "same-origin" });
      const j = await r.json().catch(() => ({}));
      if (!r.ok) return alert(j.error || "削除に失敗しました");

      alert("アカウントを削除しました");
      location.href = "/index.html";
    };

    function escapeHtml(s) {
      return String(s ?? "").replace(/[&<>"']/g, (c) => ({
        "&": "&amp;",
        "<": "&lt;",
        ">": "&gt;",
        '"': "&quot;",
        "'": "&#39;",
      }[c]));
    }

    function formatDate(iso) {
      try {
        if (!iso) return "";
        const d = new Date(iso);
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, "0");
        const day = String(d.getDate()).padStart(2, "0");
        return `${y}/${m}/${day}`;
      } catch {
        return "";
      }
    }

    function parseTags(tags) {
      if (typeof tags === "string") {
        return tags.split(/[,、]/).map((s) => s.trim()).filter(Boolean);
      }
      if (Array.isArray(tags)) return tags;
      return [];
    }

    function renderMyIdeas(items) {
      const grid = document.getElementById("myIdeasGrid");
      const empty = document.getElementById("myIdeasEmpty");

      if (!items || items.length === 0) {
        grid.innerHTML = "";
        empty.style.display = "";
        return;
      }
      empty.style.display = "none";

      grid.innerHTML = items.map((it) => {
        const id = it.id;

        const title = escapeHtml(it.product_name ?? "");
        const desc = String(it.idea_text ?? "");
        const snippet = escapeHtml(desc).slice(0, 120) + (desc.length > 120 ? "…" : "");
        const created = formatDate(it.created_at);

        const isPub = it.status === "published";
        const statusText = isPub ? "公開" : "下書き";
        const statusClass = isPub ? "pub" : "draft";

        const tags = parseTags(it.tags);
        const tagsHtml = tags.length
          ? tags.map((t) => `<span class="badge">${escapeHtml(t)}</span>`).join("")
          : `<span class="badge muted">タグなし</span>`;

        const likes = Number(it.like_count ?? 0);

        const href = `detail.html?id=${encodeURIComponent(id)}`;

        return `
          <a class="idea" href="${href}">
            <div class="title">
              <span>${title}</span>
              <span class="badge ${statusClass}">${statusText}</span>
            </div>

            <div class="meta">
              <span>${created}</span>
              <span>作成者：you</span>
            </div>

            <div class="badges">${tagsHtml}</div>

            <p class="snippet">${snippet}</p>

            <div class="footer" style="display:flex; justify-content:space-between; align-items:center;">
              <span class="small like-wrap" title="いいね数">
                <span>♡</span>
                <span class="badge like-count">${Number.isFinite(likes) ? likes : 0}</span>
              </span>

              <div class="my-idea-actions">
                <a class="btn ghost" href="detail.html?id=${encodeURIComponent(id)}">開く</a>
                <a class="btn" href="edit.html?id=${encodeURIComponent(id)}">編集</a>
              </div>
            </div>
          </a>
        `;
      }).join("");

      // ✅ 外側カード（a.idea）の遷移を、内側のボタンで止める（開く/編集が押しやすくなる）
      grid.querySelectorAll(".my-idea-actions a").forEach((a) => {
        a.addEventListener("click", (e) => e.stopPropagation());
      });
    }

    async function loadMyIdeas() {
      const r = await fetch("/api/my/ideas", { credentials: "same-origin" });
      const data = await r.json().catch(() => []);
      if (!r.ok) throw new Error(data?.error || "failed");
      renderMyIdeas(data);
    }

    ensureLogin()
      .then((me) => (me ? loadMyIdeas() : null))
      .catch(() => {});
  </script>
</body>
</html>
